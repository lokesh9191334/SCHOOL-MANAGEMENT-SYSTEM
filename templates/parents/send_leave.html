{% extends "base.html" %}

{% block title %}Send Leave - Parent Portal{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row g-4">
    <!-- Left navigation -->
    <div class="col-lg-4 col-xl-3">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="mb-3">
            <i class="fas fa-user-circle me-2 text-primary"></i>Parent Portal
          </h5>
          <div class="list-group list-group-flush">
            <a href="{{ url_for('parents.portal') }}" class="list-group-item list-group-item-action">
              <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <a href="{{ url_for('parents.student_details') }}" class="list-group-item list-group-item-action">
              <i class="fas fa-user-graduate me-2"></i>Student Details
            </a>
            <a href="{{ url_for('parents.send_leave') }}" class="list-group-item list-group-item-action active">
              <i class="fas fa-calendar-minus me-2"></i>Send Leave
            </a>
            <a href="{{ url_for('parents.leave_history') }}" class="list-group-item list-group-item-action">
              <i class="fas fa-history me-2"></i>Leave History
            </a>
            <a href="{{ url_for('parents.messages') }}" class="list-group-item list-group-item-action">
              <i class="fas fa-envelope-open-text me-2"></i>Messages
            </a>
            <a href="{{ url_for('parents.announcements') }}" class="list-group-item list-group-item-action">
              <i class="fas fa-bullhorn me-2"></i>Announcements
            </a>
            <a href="{{ url_for('parents.documents') }}" class="list-group-item list-group-item-action">
              <i class="fas fa-file-alt me-2"></i>Documents
            </a>
            <a href="{{ url_for('parents.fees') }}" class="list-group-item list-group-item-action">
              <i class="fas fa-money-bill-wave me-2"></i>Fee Status
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Right form -->
    <div class="col-lg-8 col-xl-9">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">
              <i class="fas fa-calendar-minus me-2 text-primary"></i>Send Leave Request
            </h5>
            <small class="text-muted">Submit a leave request that goes directly to your childâ€™s class teacher.</small>
          </div>
          <a href="{{ url_for('parents.leave_history') }}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-clock-rotate-left me-1"></i>View History
          </a>
        </div>
        <div class="card-body">
          <form method="post">
            <div class="mb-3">
              <label for="student_id" class="form-label">Select Student</label>
              <select class="form-select" id="student_id" name="student_id" required>
                <option value="">Choose student</option>
                {% for s in students %}
                  {% set target = student_targets.get(s.id) %}
                  <option
                    value="{{ s.id }}"
                    data-class="{{ target.class_name if target }}"
                    data-teacher="{{ target.teacher_name if target }}"
                  >
                    {{ s.full_name() }}
                    {% if target.class_name %}
                      ({{ target.class_name }}
                      {% if target.teacher_name %}- Incharge: {{ target.teacher_name }}{% else %}- Incharge: Not assigned{% endif %})
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
              <small id="teacherInfo" class="text-muted d-block mt-1"></small>
            </div>

            <div class="mb-3">
              <label for="reason_type" class="form-label">Reason</label>
              <select class="form-select" id="reason_type" name="reason_type" required>
                <option value="">Select reason</option>
                <option value="urgent_home">Urgent work at home</option>
                <option value="fever_night">Fever / not well</option>
                <option value="family_function">Family function / ceremony</option>
                <option value="medical_appointment">Doctor appointment / medical checkup</option>
                <option value="urgent_many_days">Urgent leave for many days</option>
              </select>
              <small class="text-muted">Please choose the most suitable reason.</small>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" 
                       min="{{ datetime.now().strftime('%Y-%m-%d') }}" required />
                <div class="form-text">
                  <i class="fas fa-info-circle text-info me-1"></i>
                  Leave cannot start in the past
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control" 
                       min="{{ datetime.now().strftime('%Y-%m-%d') }}" />
                <div class="form-text">
                  <i class="fas fa-info-circle text-info me-1"></i>
                  End date must be after or same as start date
                </div>
              </div>
            </div>

            <div class="mb-3" id="days-wrapper" style="display: none;">
              <label for="days" class="form-label">Number of days</label>
              <div class="input-group">
                <button class="btn btn-outline-secondary" type="button" id="days-decrease">-</button>
                <input type="number" class="form-control" id="days" name="days" min="1" step="1" placeholder="Enter days">
                <button class="btn btn-outline-secondary" type="button" id="days-increase">+</button>
              </div>
              <small class="text-muted">You can increase or decrease days as needed.</small>
            </div>

            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane me-1"></i>Send Leave
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const studentSelect = document.getElementById('student_id');
    const teacherInfo = document.getElementById('teacherInfo');
    const reasonSelect = document.getElementById('reason_type');
    const daysWrapper = document.getElementById('days-wrapper');
    const daysInput = document.getElementById('days');
    const decBtn = document.getElementById('days-decrease');
    const incBtn = document.getElementById('days-increase');
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');

    function updateTeacherInfo() {
      if (!studentSelect || !teacherInfo) return;
      const opt = studentSelect.selectedOptions[0];
      if (!opt || !opt.value) {
        teacherInfo.textContent = '';
        return;
      }
      const cls = opt.getAttribute('data-class') || '';
      const teacher = opt.getAttribute('data-teacher') || '';
      if (cls && teacher) {
        teacherInfo.textContent = `This leave will be sent to class incharge ${teacher} (Class: ${cls}).`;
      } else if (cls && !teacher) {
        teacherInfo.textContent = `No class incharge assigned yet for ${cls}. Please contact school if you face any issue.`;
      } else {
        teacherInfo.textContent = '';
      }
    }

    function updateDaysVisibility() {
      if (reasonSelect.value === 'urgent_many_days') {
        daysWrapper.style.display = 'block';
        if (!daysInput.value) {
          daysInput.value = 1;
        }
      } else {
        daysWrapper.style.display = 'none';
        if (daysInput) {
          daysInput.value = '';
        }
      }
    }

    function updateEndDateMin() {
      if (startDateInput && endDateInput) {
        const startDate = startDateInput.value;
        if (startDate) {
          endDateInput.min = startDate;
        }
      }
    }

    function validateDates() {
      const startDate = new Date(startDateInput.value);
      const endDate = new Date(endDateInput.value);
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Set to start of day

      // Validate start date is not in past
      if (startDate < today) {
        startDateInput.setCustomValidity('Start date cannot be in the past');
        return false;
      } else {
        startDateInput.setCustomValidity('');
      }

      // Validate end date is after or same as start date
      if (endDateInput.value && endDate < startDate) {
        endDateInput.setCustomValidity('End date must be after or same as start date');
        return false;
      } else {
        endDateInput.setCustomValidity('');
      }

      return true;
    }

    if (reasonSelect) {
      reasonSelect.addEventListener('change', updateDaysVisibility);
      updateDaysVisibility();
    }

    if (studentSelect) {
      studentSelect.addEventListener('change', updateTeacherInfo);
      updateTeacherInfo();
    }

    if (startDateInput) {
      startDateInput.addEventListener('change', function() {
        updateEndDateMin();
        validateDates();
      });
    }

    if (endDateInput) {
      endDateInput.addEventListener('change', validateDates);
    }

    // Form submission validation
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        if (!validateDates()) {
          e.preventDefault();
          alert('Please check the dates. Start date cannot be in the past and end date must be after or same as start date.');
        }
      });
    }

    if (decBtn && daysInput) {
      decBtn.addEventListener('click', function () {
        let current = parseInt(daysInput.value || '1', 10);
        if (current > 1) {
          daysInput.value = current - 1;
        }
      });
    }

    if (incBtn && daysInput) {
      incBtn.addEventListener('click', function () {
        let current = parseInt(daysInput.value || '1', 10);
        daysInput.value = current + 1;
      });
    }
  });
</script>
{% endblock %}

