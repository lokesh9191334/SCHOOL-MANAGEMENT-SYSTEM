{% extends "base.html" %}

{% block title %}Premium Fees Management{% endblock %}

{% block content %}
<div class="container-fluid fade-in-up">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-dollar-sign fa-2x mb-2 text-primary"></i>
                    <h3 id="totalFees">{{ fees|length }}</h3>
                    <p class="card-text">Total Fees</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                    <h3 id="paidFees">{{ fees|selectattr('status', 'equalto', 'paid')|list|length }}</h3>
                    <p class="card-text">Paid Fees</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x mb-2 text-warning"></i>
                    <h3 id="pendingFees">{{ fees|selectattr('status', 'equalto', 'pending')|list|length }}</h3>
                    <p class="card-text">Pending Fees</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x mb-2 text-info"></i>
                    <h3 id="totalAmount">₹{{ "%.2f"|format(fees|map(attribute='amount')|map('float')|sum) }}</h3>
                    <p class="card-text">Total Amount</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-search"></i>
                Search & Filters
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by student name...">
                </div>
                <div class="col-md-2">
                    <select id="statusFilter" class="form-control">
                        <option value="">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="feeTypeFilter" class="form-control">
                        <option value="">All Fee Types</option>
                        {% for fee_type in fee_types %}
                        <option value="{{ fee_type.id }}">{{ fee_type.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="classroomFilter" class="form-control">
                        <option value="">All Classes</option>
                        {% for classroom in classrooms %}
                        <option value="{{ classroom.id }}">{{ classroom.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="streamFilter" class="form-control">
                        <option value="">All Streams</option>
                        {% for stream in streams %}
                        <option value="{{ stream }}">{{ stream }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="clearFilters" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between mb-3">
        <div>
            <button id="refreshBtn" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div>
            <a href="{{ url_for('fees.create_fee') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Add New Fee
            </a>
            <a href="{{ url_for('fees.fee_types') }}" class="btn btn-outline-info">
                <i class="fas fa-tags"></i> Fee Types
            </a>
        </div>
    </div>

    <!-- Fees Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-list"></i>
                Fees List
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="feesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Student</th>
                            <th>Fee Type</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fee in fees %}
                        <tr class="fee-row" data-student="{{ fee.student.name }}" data-amount="{{ fee.amount }}" data-status="{{ fee.status }}">
                            <td>{{ fee.student.name }}</td>
                            <td>{{ fee.fee_type.name }}</td>
                            <td>₹{{ "%.2f"|format(fee.amount) }}</td>
                            <td>{{ fee.due_date.strftime('%d/%m/%Y') }}</td>
                            <td>
                                {% if fee.status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                                {% elif fee.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                                {% else %}
                                <span class="badge bg-danger">Overdue</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if fee.status != 'paid' %}
                                <button class="btn btn-sm btn-success" onclick="markAsPaid({{ fee.id }}, '{{ fee.student.name }}', {{ fee.amount }})">
                                    <i class="fas fa-check"></i> Mark Paid
                                </button>
                                {% endif %}
                                <a href="{{ url_for('fees.edit_fee', id=fee.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <button class="btn btn-sm btn-danger" onclick="deleteFee({{ fee.id }})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Process Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="paymentForm">
                <div class="modal-body">
                    <input type="hidden" id="feeId" name="fee_id">
                    <div class="mb-3">
                        <label class="form-label">Student Name</label>
                        <input type="text" class="form-control" id="studentName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fee Amount</label>
                        <input type="text" class="form-control" id="feeAmount" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-control" id="payment_method" name="payment_method" onchange="togglePaymentMethod()">
                            <option value="cash">Cash</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="qr">QR Code Payment</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="payment_date" name="payment_date" required>
                    </div>

                    <!-- QR Code Payment Section -->
                    <div id="qrPaymentSection" style="display: none; margin-top: 20px;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-qrcode me-2"></i>QR Code Payment</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Amount to Pay:</strong> <span id="qrAmount" class="text-success fw-bold">₹0.00</span></p>
                                    <p><strong>UPI ID:</strong> lk5278127-1@okicici</p>
                                    <p><strong>Merchant:</strong> Bank of Baroda</p>
                                </div>
                                <div class="col-md-6">
                                    <div id="qrCodeContainer" class="text-center">
                                        <div id="qrCode" style="width: 200px; height: 200px; margin: 0 auto; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                            <div class="text-muted">
                                                <i class="fas fa-qrcode fa-3x mb-2"></i>
                                                <br>QR Code will appear here
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2 mt-3">
                                        <button type="button" id="generateQRBtn" class="btn btn-primary" onclick="generateQRCode()">
                                            <i class="fas fa-qrcode me-2"></i>Generate QR Code
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="paymentStatus" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Process Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables
let currentFeeId = null;

// Updated markAsPaid function that accepts parameters directly
function markAsPaid(feeId, studentName, feeAmount) {
    currentFeeId = feeId;
    // Populate modal with provided data
    document.getElementById('feeId').value = feeId;
    document.getElementById('studentName').value = studentName || 'N/A';
    document.getElementById('feeAmount').value = `₹${parseFloat(feeAmount || 0).toFixed(2)}`;
    // Set today's date as default payment date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payment_date').value = today;
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

function togglePaymentMethod() {
    const paymentMethod = document.getElementById('payment_method').value;
    const qrSection = document.getElementById('qrPaymentSection');

    if (paymentMethod === 'qr') {
        qrSection.style.display = 'block';
        // Update amount display
        const amount = document.getElementById('feeAmount').value.replace('₹', '');
        document.getElementById('qrAmount').textContent = '₹' + parseFloat(amount).toFixed(2);
    } else {
        qrSection.style.display = 'none';
    }
}

function generateQRCode() {
    const amount = document.getElementById('feeAmount').value.replace('₹', '');
    const upiId = 'lk5278127-1@okicici';
    const merchantName = 'Bank of Baroda';

    // Create UPI URL
    const upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR`;

    // Clear previous QR code
    const qrContainer = document.getElementById('qrCode');
    qrContainer.innerHTML = '';

    // Generate QR code
    QRCode.toCanvas(upiUrl, {
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: 'H'
    }, function(error, canvas) {
        if (error) {
            console.error(error);
            qrContainer.innerHTML = '<div class="text-danger">Error generating QR code</div>';
            return;
        }

        // Style the canvas
        canvas.style.cssText = 'background: white; padding: 10px; border-radius: 5px;';

        // Create wrapper for styling
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'background: white; padding: 10px; border-radius: 5px; display: inline-block;';

        // Add some visual elements
        const topLine = document.createElement('div');
        topLine.style.cssText = 'position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px;';

        const bottomLine = document.createElement('div');
        bottomLine.style.cssText = 'position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px;';

        wrapper.appendChild(topLine);
        wrapper.appendChild(canvas);
        wrapper.appendChild(bottomLine);

        // Insert wrapper before canvas and move canvas into wrapper
        qrContainer.insertBefore(wrapper, qrContainer.firstChild);
        wrapper.appendChild(canvas);

        // Update UI
        const generateBtn = document.getElementById('generateQRBtn');
        const statusDiv = document.getElementById('paymentStatus');

        generateBtn.style.display = 'none';
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-info';
        statusDiv.innerHTML = '<i class="fas fa-mobile-alt me-2"></i>Scan QR code with any UPI app to make payment';
    });
}

function completePayment() {
    const statusDiv = document.getElementById('paymentStatus');
    const scanBtn = document.getElementById('scanCompleteBtn');

    statusDiv.className = 'alert alert-success';
    statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Payment completed successfully!';
    scanBtn.disabled = true;
    scanBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Payment Confirmed';

    // Auto-hide success message after 3 seconds and process payment
    setTimeout(() => {
        statusDiv.style.display = 'none';
        // Now process the actual payment
        processPayment();
    }, 3000);
}

// Update QR amount when payment amount changes
document.getElementById('paymentAmount').addEventListener('input', function() {
    const amount = this.value || '0.00';
    document.getElementById('qrAmount').textContent = '₹' + parseFloat(amount).toFixed(2);
});

function processPayment() {
    const formData = new FormData(document.getElementById('paymentForm'));

    fetch('/api/process_payment', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and refresh page
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error processing payment: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing payment');
    });
}

function deleteFee(feeId) {
    if (confirm('Are you sure you want to delete this fee?')) {
        fetch(`/fees/${feeId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting fee: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting fee');
        });
    }
}

// Search and filter functionality
document.getElementById('searchInput').addEventListener('input', filterFees);
document.getElementById('statusFilter').addEventListener('change', filterFees);
document.getElementById('feeTypeFilter').addEventListener('change', filterFees);
document.getElementById('classroomFilter').addEventListener('change', filterFees);
document.getElementById('streamFilter').addEventListener('change', filterFees);

function filterFees() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const feeTypeFilter = document.getElementById('feeTypeFilter').value;
    const classroomFilter = document.getElementById('classroomFilter').value;
    const streamFilter = document.getElementById('streamFilter').value;

    const rows = document.querySelectorAll('#feesTable tbody tr');

    rows.forEach(row => {
        const studentName = row.cells[0].textContent.toLowerCase();
        const feeType = row.cells[1].textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        const classroom = row.getAttribute('data-classroom') || '';
        const stream = row.getAttribute('data-stream') || '';

        const matchesSearch = studentName.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesFeeType = !feeTypeFilter || feeType.includes(feeTypeFilter.toLowerCase());
        const matchesClassroom = !classroomFilter || classroom === classroomFilter;
        const matchesStream = !streamFilter || stream === streamFilter;

        if (matchesSearch && matchesStatus && matchesFeeType && matchesClassroom && matchesStream) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

document.getElementById('clearFilters').addEventListener('click', function() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('feeTypeFilter').value = '';
    document.getElementById('classroomFilter').value = '';
    document.getElementById('streamFilter').value = '';
    filterFees();
});

document.getElementById('refreshBtn').addEventListener('click', function() {
    location.reload();
});

// Initialize tooltips and other UI elements
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips if any
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<style>
.fee-row {
    transition: all 0.3s ease;
}

.fee-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 255, 255, 0.2);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.stats-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 8px 25px rgba(0, 255, 255, 0.3);
}

.btn-outline-warning:hover {
    background: linear-gradient(135deg, var(--warning-color), #ff6600);
    border-color: var(--warning-color);
}

.btn-outline-success:hover {
    background: linear-gradient(135deg, var(--success-color), #00aa00);
    border-color: var(--success-color);
}

.btn-outline-info:hover {
    background: linear-gradient(135deg, var(--info-color), #aaaa00);
    border-color: var(--info-color);
}

.btn-outline-danger:hover {
    background: linear-gradient(135deg, var(--danger-color), #aa0080);
    border-color: var(--danger-color);
}
</style>
{% endblock %}
