{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-lg-4 offset-lg-4">
      <div class="card shadow-lg" id="receiptSlip" style="width: 300px; margin: 0 auto;">
        <div class="card-header bg-primary text-white text-center p-2">
          <h6 class="mb-0"><i class="fas fa-receipt me-1"></i>PAYMENT RECEIPT</h6>
        </div>

        <div class="card-body p-3" id="printableArea" style="font-family: 'Courier New', monospace; font-size: 11px;">
          <!-- Receipt Header -->
          <div class="text-center mb-2 pb-2 border-bottom">
            <h6 class="mb-0 fw-bold">SCHOOL MANAGEMENT</h6>
            <small class="text-muted">Financial Receipt</small>
          </div>

          <!-- Receipt Number & Transaction Details -->
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-0 mb-1">
              <div class="col-5"><span class="fw-bold">Receipt #:</span></div>
              <div class="col-7 text-truncate">{{ receipt.receipt_number }}</div>
            </div>
            {%- set payment = receipt.payment if receipt.payment else None -%}
            {% if payment and payment.transaction_id %}
            <div class="row g-0 mb-1">
              <div class="col-5"><span class="fw-bold">Trans ID:</span></div>
              <div class="col-7 text-truncate">{{ payment.transaction_id }}</div>
            </div>
            {% endif %}
            <div class="row g-0 mb-1">
              <div class="col-5"><span class="fw-bold">Date:</span></div>
              <div class="col-7">{{ receipt.issued_date.strftime('%d/%m/%Y') }}</div>
            </div>
            <div class="row g-0">
              <div class="col-5"><span class="fw-bold">Time:</span></div>
              <div class="col-7">{{ receipt.issued_date.strftime('%H:%M:%S') }}</div>
            </div>
          </div>

          <!-- Student/Payer Information -->
          <div class="mb-2 pb-2 border-bottom">
            <div class="row g-0 mb-1">
              <div class="col-5"><span class="fw-bold">Name:</span></div>
              <div class="col-7 text-truncate">{{ receipt.issued_to }}</div>
            </div>
            {%- set student = receipt.payment.fee.student if receipt.payment and receipt.payment.fee and receipt.payment.fee.student else None -%}
            <div class="row g-0 mb-1">
              <div class="col-5"><span class="fw-bold">Class:</span></div>
              <div class="col-7 text-truncate">
                {% if student %}
                  {% if student.enrollments and student.enrollments|length > 0 %}
                    {% set cls_obj = student.enrollments[0].classroom %}
                    {{ cls_obj.name or cls_obj.grade or '-' }}
                  {% else %}
                    -
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </div>
            </div>
            <div class="row g-0 mb-1">
              <div class="col-5"><span class="fw-bold">Father:</span></div>
              <div class="col-7 text-truncate">
                {%- set student = receipt.payment.fee.student if receipt.payment and receipt.payment.fee and receipt.payment.fee.student else None -%}
                {{ (receipt.parent_name if receipt.parent_name else (student.parent_name if student and student.parent_name else (student.guardian_name if student and student.guardian_name else '-'))) }}
              </div>
            </div>
            <div class="row g-0 mb-1">
              <div class="col-5"><span class="fw-bold">Method:</span></div>
              <div class="col-7">{{ receipt.payment_method }}</div>
            </div>
            {% if receipt.notes %}
            <div class="row g-0">
              <div class="col-5"><span class="fw-bold">Ref:</span></div>
              <div class="col-7 text-truncate" style="font-size: 10px;">{{ receipt.notes[:15] }}</div>
            </div>
            {% endif %}
          </div>

          <!-- Amount Section -->
          <div class="text-center mb-2 pb-2 border-bottom">
            <small class="text-muted" style="font-size: 10px;">Amount Received</small>
            <h5 class="mb-1 fw-bold">â‚¹{{ "%.2f"|format(receipt.total_amount) }}</h5>
            <small class="text-muted" style="font-size: 10px;">{{ "{:.0f}".format(receipt.total_amount) }} Rupees</small>
          </div>

          <!-- Transaction Details -->
          <div class="mb-2 pb-2 border-bottom" style="font-size: 10px;">
            <div class="row g-0 mb-1">
              <div class="col-6"><span class="fw-bold">Receipt ID:</span></div>
              <div class="col-6 text-end">{{ receipt.id }}</div>
            </div>
            <div class="row g-0 mb-1">
              <div class="col-6"><span class="fw-bold">Transaction:</span></div>
              <div class="col-6 text-end">{{ receipt.receipt_number }}</div>
            </div>
            <div class="row g-0">
              <div class="col-6"><span class="fw-bold">Status:</span></div>
              <div class="col-6 text-end">COMPLETED</div>
            </div>
          </div>

          <!-- Footer -->
          <div class="text-center" style="font-size: 9px;">
            <p class="mb-1 text-muted">Thank you for your payment</p>
            <p class="mb-1 fw-bold">Receipt #{{ receipt.receipt_number }}</p>
            <div class="mt-2 pt-2 border-top">
              <small class="text-muted">Keep this receipt for your records</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Print Button -->
      <div class="text-center mt-3 no-print">
        <button class="btn btn-primary" onclick="window.print()">
          <i class="fas fa-print me-2"></i>Print Receipt
        </button>
        <button class="btn btn-secondary" onclick="window.history.back()">
          <i class="fas fa-arrow-left me-2"></i>Back
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  #receiptSlip {
    max-width: 300px;
    border: 2px solid #333;
  }

  #printableArea {
    background: white;
    min-height: auto;
  }

  .no-print {
    margin-top: 20px;
  }

  /* Hide everything except the receipt when printing */
  @media print {
    * {
      margin: 0;
      padding: 0;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    /* Hide sidebar and navbar */
    nav, .sidebar, .navbar, .container-fluid > .row > :not(.col-lg-4) {
      display: none !important;
    }

    html, body {
      width: 80mm;
      height: auto;
      background: white;
      padding: 0;
      margin: 0;
      overflow: visible;
    }

    body {
      overflow: visible;
    }

    .container-fluid {
      max-width: 80mm;
      margin: 0;
      padding: 0;
      width: 80mm;
    }

    .row {
      margin: 0 !important;
      width: 100% !important;
      display: flex !important;
    }

    .col-lg-4, .offset-lg-4 {
      max-width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      flex: 0 0 100% !important;
    }

    #receiptSlip {
      max-width: 100%;
      width: 80mm;
      margin: 0;
      padding: 0;
      border: 1px solid #000;
      box-shadow: none;
    }

    .card-header {
      background-color: #0d6efd !important;
      color: white !important;
      border: 1px solid #000 !important;
    }

    .card-body {
      border: 1px solid #000;
      padding: 10px !important;
    }

    .card {
      border: 1px solid #000 !important;
      margin: 0 !important;
    }

    .no-print {
      display: none !important;
    }

    .text-muted {
      color: #666 !important;
    }

    @page {
      size: 80mm auto;
      margin: 0;
      padding: 0;
    }
  }

  @media (max-width: 768px) {
    #receiptSlip {
      max-width: 100%;
      width: 100%;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Auto-print if URL has ?print=1
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('print') === '1') {
      setTimeout(() => {
        // Close window after printing
        window.print();
        setTimeout(() => {
          window.close();
        }, 1000);
      }, 300);
    }
  });
</script>
{% endblock %}
