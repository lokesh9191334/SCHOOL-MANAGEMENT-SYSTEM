{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-bell"></i> Authorized Activity Log</h2>
    <hr>
    <form class="row g-2 mb-3" method="get">
        <div class="col-md-2">
            <select name="category" class="form-select">
                <option value="">All categories</option>
                <option value="success" {% if filters.category=='success' %}selected{% endif %}>Success</option>
                <option value="info" {% if filters.category=='info' %}selected{% endif %}>Info</option>
                <option value="warning" {% if filters.category=='warning' %}selected{% endif %}>Warning</option>
                <option value="danger" {% if filters.category=='danger' %}selected{% endif %}>Danger</option>
            </select>
        </div>
        <div class="col-md-2">
            <input name="user_id" value="{{ filters.user_id or '' }}" placeholder="User ID" class="form-control"/>
        </div>
        <div class="col-md-2">
            <input name="ip" value="{{ filters.ip or '' }}" placeholder="IP" class="form-control"/>
        </div>
        <div class="col-md-2">
            <input name="start_date" value="{{ filters.start_date or '' }}" placeholder="Start YYYY-MM-DD" class="form-control"/>
        </div>
        <div class="col-md-2">
            <input name="end_date" value="{{ filters.end_date or '' }}" placeholder="End YYYY-MM-DD" class="form-control"/>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary">Filter</button>
        </div>
    </form>
    {% if logs %}
        <div class="list-group">
            {% for log in logs %}
                <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 
                    {% if log.category == 'danger' %}list-group-item-danger
                    {% elif log.category == 'warning' %}list-group-item-warning
                    {% elif log.category == 'success' %}list-group-item-success
                    {% else %}list-group-item-info{% endif %}
                    {% if log.user is none %}border-warning border-2{% endif %}">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">
                            {% if log.category == 'danger' %}<i class="fas fa-exclamation-circle"></i> 
                                {% if log.user is none %}ðŸš¨ {% endif %}Unauthorized Access
                            {% elif log.category == 'warning' %}<i class="fas fa-exclamation-triangle"></i> Warning
                            {% elif log.category == 'success' %}<i class="fas fa-check-circle"></i> Success
                            {% else %}<i class="fas fa-info-circle"></i> Info{% endif %}
                            - {{ log.message }}
                        </h5>
                        <small>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                    </div>
                    <p class="mb-1">{{ log.message }}</p>
                    <small>
                        {% if log.user %}User: {{ log.user.name }} (ID: {{ log.user.id }}){% else %}System{% endif %}
                        {% if log.ip_address %}
                            <div class="ip-info-section mt-2 p-2 bg-light rounded">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-network-wired me-2 text-primary"></i>
                                    <strong>IP Address:</strong>
                                    <code class="ms-2">{{ log.ip_address }}</code>
                                    {% if log.ip_type %}
                                        <span class="badge ms-2 
                                            {% if log.ip_type == 'public' %}bg-success
                                            {% elif log.ip_type == 'private' %}bg-warning text-dark
                                            {% elif log.ip_type == 'local' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ log.ip_type.title() }}
                                        </span>
                                    {% endif %}
                                </div>
                                
                                {% if log.ip_type == 'private' %}
                                    <div class="text-warning small">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        Private Network - Internal/LAN Access
                                    </div>
                                {% elif log.ip_type == 'public' %}
                                    <div class="text-success small">
                                        <i class="fas fa-globe me-1"></i>
                                        Public Internet - External Access
                                    </div>
                                {% elif log.ip_type == 'local' %}
                                    <div class="text-info small">
                                        <i class="fas fa-wifi me-1"></i>
                                        Local Network - Same Machine
                                    </div>
                                {% endif %}
                                
                                {% if log.remote_addr and log.remote_addr != log.ip_address %}
                                    <div class="text-muted small mt-1">
                                        <i class="fas fa-desktop me-1"></i>
                                        Direct Connection: {{ log.remote_addr }}
                                    </div>
                                {% endif %}
                                
                                {% if log.x_forwarded_for %}
                                    <div class="text-muted small mt-1">
                                        <i class="fas fa-exchange-alt me-1"></i>
                                        Proxy Chain: {{ log.x_forwarded_for }}
                                    </div>
                                {% endif %}
                                
                                {% if log.x_real_ip and log.x_real_ip != log.ip_address %}
                                    <div class="text-muted small mt-1">
                                        <i class="fas fa-user me-1"></i>
                                        Real IP: {{ log.x_real_ip }}
                                    </div>
                                {% endif %}
                                
                                {% if log.x_client_ip and log.x_client_ip != log.ip_address %}
                                    <div class="text-muted small mt-1">
                                        <i class="fas fa-laptop me-1"></i>
                                        Client IP: {{ log.x_client_ip }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% if log.user is none %}
                                <span class="badge bg-danger ms-2 mt-2">
                                    <i class="fas fa-user-secret"></i> Unauthorized Access Attempt
                                </span>
                            {% endif %}
                        {% endif %}
                    </small>
                </div>
            {% endfor %}
        </div>
        <nav aria-label="Activity pagination" class="mt-3">
            <ul class="pagination">
                {% if page > 1 %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('dashboard.authorized_activity', page=page-1, per_page=per_page, category=filters.category, user_id=filters.user_id, ip=filters.ip, start_date=filters.start_date, end_date=filters.end_date) }}">Previous</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {% for p in range(1, total_pages+1) %}
                    <li class="page-item {% if p==page %}active{% endif %}"><a class="page-link" href="{{ url_for('dashboard.authorized_activity', page=p, per_page=per_page, category=filters.category, user_id=filters.user_id, ip=filters.ip, start_date=filters.start_date, end_date=filters.end_date) }}">{{ p }}</a></li>
                {% endfor %}

                {% if page < total_pages %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('dashboard.authorized_activity', page=page+1, per_page=per_page, category=filters.category, user_id=filters.user_id, ip=filters.ip, start_date=filters.start_date, end_date=filters.end_date) }}">Next</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
            </ul>
        </nav>
    {% else %}
        <div class="alert alert-info" role="alert">
            No activity logs found.
        </div>
    {% endif %}
</div>
{% endblock %}