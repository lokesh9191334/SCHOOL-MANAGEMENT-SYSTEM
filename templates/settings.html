{% extends "base.html" %}

{% block extra_css %}
  <link href="{{ url_for('static', filename='css/settings.css') }}?v={{ g.request_id }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid settings-page">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-cog me-2"></i>Settings</h2>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h4>School Information</h4>
              <div class="setting-item mb-4">
                <label for="schoolName" class="form-label fw-bold">School Name</label>
                <input type="text" class="form-control" id="schoolName" value="School Management System">
                <div class="form-text">This name will appear throughout the application</div>
              </div>
              
              <div class="setting-item mb-4">
                <label for="schoolLogoFile" class="form-label fw-bold">School Logo</label>
                <input type="file" class="form-control" id="schoolLogoFile" accept="image/*">
                <div class="form-text">Upload your school's logo. It will appear in the header and for app install.</div>
                <button type="button" class="btn btn-outline-primary mt-2" onclick="uploadLogo()">Upload Logo</button>
              </div>

              <h4 class="mt-4">Appearance</h4>
              <div class="setting-item mb-4">
                <label class="form-label fw-bold">Theme</label>
                <div class="theme-options">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="theme" id="premiumTheme" value="premiumTheme" onchange="applyTheme('premiumTheme')">
                    <label class="form-check-label" for="premiumTheme">
                      Premium Theme
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="theme" id="darkTheme" value="darkTheme" onchange="applyTheme('darkTheme')">
                    <label class="form-check-label" for="darkTheme">
                      Dark Theme
                    </label>
                  </div>
                </div>
                <div class="form-text mt-2">Select your preferred theme for the application</div>
              </div>

              <h4 class="mt-4">Notifications</h4>
              <div class="setting-item">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                  <label class="form-check-label" for="emailNotifications">
                    Email Notifications
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="smsNotifications">
                  <label class="form-check-label" for="smsNotifications">
                    SMS Notifications
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="pushNotifications" checked>
                  <label class="form-check-label" for="pushNotifications">
                    Push Notifications
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h4>Language & Region</h4>
              <div class="setting-item mb-4">
                <label for="languageSelect" class="form-label fw-bold">Language</label>
                <select class="form-select" id="languageSelect" onchange="changeLanguage(this.value)">
                  <option value="en">English</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="hi">Hindi</option>
                </select>
                <div class="form-text mt-2">Select your preferred language for the application</div>
              </div>

              <div class="setting-item mb-4">
                <label for="timezoneSelect" class="form-label fw-bold">Timezone</label>
                <select class="form-select" id="timezoneSelect">
                  <option selected>UTC-5 (Eastern Time)</option>
                  <option>UTC-6 (Central Time)</option>
                  <option>UTC-7 (Mountain Time)</option>
                  <option>UTC-8 (Pacific Time)</option>
                  <option>UTC+0 (GMT)</option>
                </select>
              </div>

              <h4 class="mt-4">Security</h4>
              <div class="setting-item">
                <button type="button" class="btn btn-outline-primary mb-2" onclick="changePassword()">Change Password</button>
                <br>
                <button type="button" class="btn btn-outline-warning mb-2" onclick="toggleTwoFactor()">Enable Two-Factor Auth</button>
                <br>
                <button type="button" class="btn btn-outline-danger" onclick="viewLoginHistory()">View Login History</button>
              </div>

              <h4 class="mt-4">System Information</h4>
              <div class="setting-item">
                <div class="system-info-row mb-2">
                  <strong>System Name:</strong>
                  <span>School Management System</span>
                </div>
                <div class="system-info-row mb-2">
                  <strong>Version:</strong>
                  <span>1.0.0</span>
                </div>
                <div class="system-info-row mb-2">
                  <strong>Database:</strong>
                  <span>SQLite 3</span>
                </div>
                <div class="system-info-row mb-2">
                  <strong>Framework:</strong>
                  <span>Flask (Python)</span>
                </div>
                <div class="system-info-row mb-2">
                  <strong>Last Updated:</strong>
                  <span>November 14, 2025</span>
                </div>
                <div class="system-info-row">
                  <strong>Support Email:</strong>
                  <span><a href="mailto:schoolmanagementsystem091@gmail.com" style="color: #4a9bff;">schoolmanagementsystem091@gmail.com</a></span>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-12">
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" onclick="resetSettings()">Reset to Defaults</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 rounded-lg shadow-lg overflow-hidden">
      <div class="modal-header bg-primary text-white">
        <h1 class="modal-title fs-5 fw-bold" id="changePasswordModalLabel">
          <i class="fas fa-key me-2"></i>Change Password
        </h1>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-5">
        <div class="alert alert-info mb-4">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Password Requirements:</strong> Minimum 8 characters with uppercase, lowercase, and numbers.
        </div>
        <div class="mb-4">
          <label for="settingsCurrentPassword" class="form-label fw-bold">Current Password</label>
          <input type="password" class="form-control form-control-lg" id="settingsCurrentPassword" placeholder="Enter your current password">
          <div class="form-text">We need your current password to confirm the change</div>
        </div>
        <div class="mb-4">
          <label for="settingsNewPassword" class="form-label fw-bold">New Password</label>
          <input type="password" class="form-control form-control-lg" id="settingsNewPassword" placeholder="Enter your new password">
          <div id="settingsPasswordStrength" class="form-text mt-2"></div>
        </div>
        <div class="mb-4">
          <label for="settingsConfirmPassword" class="form-label fw-bold">Confirm New Password</label>
          <input type="password" class="form-control form-control-lg" id="settingsConfirmPassword" placeholder="Confirm your new password">
          <div id="settingsPasswordMatch" class="form-text mt-2"></div>
        </div>
      </div>
      <div class="modal-footer bg-light border-top p-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitSettingsPasswordChange()">
          <i class="fas fa-check me-2"></i>Update Password
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts moved to static/js/main.js -->

<!-- Additional Settings Scripts -->
<script>
// Theme change function
function applyTheme(theme) {
  if (theme === 'darkTheme') {
    document.body.classList.add('dark-theme');
    document.body.classList.remove('blue-white-theme');
    localStorage.setItem('schoolTheme', 'darkTheme');
  } else {
    document.body.classList.add('blue-white-theme');
    document.body.classList.remove('dark-theme');
    localStorage.setItem('schoolTheme', 'premiumTheme');
  }
}

// Language change function
function changeLanguage(language) {
  // Save language preference
  localStorage.setItem('selectedLanguage', language);
  
  // Show loading message
  const message = document.createElement('div');
  message.className = 'alert alert-info position-fixed';
  message.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  message.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Changing language...';
  document.body.appendChild(message);
  
  // Simulate language change (in real app, this would reload with translations)
  setTimeout(() => {
    message.remove();
    alert(`Language changed to ${getLanguageName(language)}. Page will refresh to apply changes.`);
    // In a real application, you would reload the page or update translations
    // window.location.reload();
  }, 1000);
}

// Get language display name
function getLanguageName(code) {
  const languages = {
    'en': 'English',
    'es': 'Spanish',
    'fr': 'French', 
    'de': 'German',
    'hi': 'Hindi'
  };
  return languages[code] || code;
}

// Load saved language on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
  const languageSelect = document.getElementById('languageSelect');
  if (languageSelect) {
    languageSelect.value = savedLanguage;
  }
});

// Enhanced save settings function
function saveSettings() {
  const schoolNameEl = document.getElementById('schoolName');
  const premium = document.getElementById('premiumTheme');
  const dark = document.getElementById('darkTheme');
  const emailEl = document.getElementById('emailNotifications');
  const smsEl = document.getElementById('smsNotifications');
  const pushEl = document.getElementById('pushNotifications');
  const langEl = document.getElementById('languageSelect');
  const tzEl = document.getElementById('timezoneSelect');
  
  // Get selected theme
  let selectedTheme = 'premiumTheme';
  if (premium && premium.checked) selectedTheme = 'premiumTheme';
  if (dark && dark.checked) selectedTheme = 'darkTheme';
  
  const payload = {
    schoolName: schoolNameEl ? schoolNameEl.value : 'School Management System',
    theme: selectedTheme,
    emailNotifications: emailEl ? !!emailEl.checked : true,
    smsNotifications: smsEl ? !!smsEl.checked : false,
    pushNotifications: pushEl ? !!pushEl.checked : true,
    language: langEl ? langEl.value : 'en',
    timezone: tzEl ? tzEl.value : 'UTC-5 (Eastern Time)',
    logo_path: localStorage.getItem('schoolLogoPath') || null
  };
  
  // Show loading state
  const saveBtn = document.querySelector('button[onclick="saveSettings()"]');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
  saveBtn.disabled = true;
  
  fetch('/settings/save', { 
    method: 'POST', 
    headers: { 'Content-Type': 'application/json' }, 
    body: JSON.stringify(payload) 
  })
    .then(r => r.json())
    .then(d => {
      if (d && d.success) {
        // Save to localStorage
        localStorage.setItem('schoolName', payload.schoolName);
        localStorage.setItem('schoolTheme', payload.theme);
        localStorage.setItem('selectedLanguage', payload.language);
        
        // Apply theme immediately
        applyTheme(payload.theme);
        
        // Update UI immediately
        try {
          var nameDisplay = document.getElementById('schoolNameDisplay');
          if (nameDisplay) nameDisplay.textContent = payload.schoolName;
          var pageTitle = document.getElementById('pageTitle');
          if (pageTitle) pageTitle.textContent = payload.schoolName;
          if (document && document.title) document.title = payload.schoolName;
        } catch (e) {}
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'alert alert-success position-fixed';
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        successMsg.innerHTML = '<i class="fas fa-check-circle me-2"></i>Settings saved successfully!';
        document.body.appendChild(successMsg);
        
        setTimeout(() => successMsg.remove(), 3000);
        
        // If language changed, show reload message
        if (langEl && langEl.value !== localStorage.getItem('previousLanguage')) {
          localStorage.setItem('previousLanguage', langEl.value);
          setTimeout(() => {
            const langMsg = document.createElement('div');
            langMsg.className = 'alert alert-info position-fixed';
            langMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            langMsg.innerHTML = '<i class="fas fa-info-circle me-2"></i>Language change will take effect on page reload.';
            document.body.appendChild(langMsg);
            setTimeout(() => langMsg.remove(), 5000);
          }, 3500);
        }
      } else {
        throw new Error(d.message || 'Failed to save settings');
      }
    })
    .catch(error => {
      console.error('Settings save error:', error);
      const errorMsg = document.createElement('div');
      errorMsg.className = 'alert alert-danger position-fixed';
      errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Failed to save settings';
      document.body.appendChild(errorMsg);
      setTimeout(() => errorMsg.remove(), 3000);
    })
    .finally(() => {
      // Restore button state
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    });
}
</script>
{% endblock %}
