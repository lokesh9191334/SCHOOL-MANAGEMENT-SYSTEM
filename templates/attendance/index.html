{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-0">
          <i class="fas fa-calendar-check me-3 text-primary"></i>
          Attendance Management
        </h2>
        <p class="text-muted mt-1">Mark and manage student attendance records</p>
      </div>
      <div class="btn-group">
        <a href="{{ url_for('attendance.mark_attendance') }}" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i>Mark Attendance
        </a>
        <a href="{{ url_for('attendance.attendance_analytics') }}" class="btn btn-outline-info">
          <i class="fas fa-chart-line me-2"></i>Analytics
        </a>
        <a href="{{ url_for('attendance.attendance_report') }}" class="btn btn-outline-success">
          <i class="fas fa-file-alt me-2"></i>Report
        </a>
        <button class="btn btn-outline-warning" onclick="exportAttendance()">
          <i class="fas fa-download me-2"></i>Export
        </button>
        <button class="btn btn-outline-danger" onclick="sendAbsentNotifications()">
          <i class="fas fa-envelope me-2"></i>Send Notifications
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Today's Attendance Overview -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card stats-card border-primary">
      <div class="card-body text-center">
        <i class="fas fa-users fa-2x text-primary mb-2"></i>
        <h3 class="text-primary">{{ students|length }}</h3>
        <p class="mb-0">Total Students</p>
        <small class="text-muted">Enrolled</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stats-card border-success">
      <div class="card-body text-center">
        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
        <h3 class="text-success">{{ attendance.values() | select | list | length }}</h3>
        <p class="mb-0">Present Today</p>
        <small class="text-muted">{{ date.strftime('%B %d, %Y') }}</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stats-card border-info">
      <div class="card-body text-center">
        <i class="fas fa-percentage fa-2x text-info mb-2"></i>
        <h3 class="text-info">
          {% set present_count = attendance.values() | select | list | length %}
          {% set total_count = students | length %}
          {{ "%.1f"|format((present_count / total_count * 100) if total_count > 0 else 0) }}%
        </h3>
        <p class="mb-0">Attendance Rate</p>
        <small class="text-muted">Today's rate</small>
      </div>
    </div>
  </div>
</div>

<!-- Mark Attendance Form -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="fas fa-edit me-2 text-warning"></i>Mark Today's Attendance
    </h5>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('attendance.mark_attendance') }}" enctype="multipart/form-data">
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="attendance_date" class="form-label">Date</label>
          <input type="date" class="form-control" id="attendance_date" name="date"
                 value="{{ date.strftime('%Y-%m-%d') }}" required>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>Photo</th>
              <th>Student Name</th>
              <th>Roll Number</th>
              <th>Class</th>
              <th>Present</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for s in students %}
            <tr>
              <td>
                {% if s.photo %}
                  <img src="{{ url_for('static', filename=s.photo) }}"
                       alt="Student Photo" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                {% else %}
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                       style="width: 40px; height: 40px; font-size: 14px; font-weight: bold;">
                    {{ s.first_name[0] }}{{ s.last_name[0] }}
                  </div>
                {% endif %}
              </td>
              <td>
                <strong>{{ s.first_name }} {{ s.last_name }}</strong>
              </td>
              <td>{{ s.roll_number or 'N/A' }}</td>
              <td>
                {% if s.classroom %}
                  <span class="badge bg-primary">{{ s.classroom.name }}</span>
                {% else %}
                  <span class="text-muted">Not assigned</span>
                {% endif %}
              </td>
              <td>
                <div class="form-check">
                  <input class="form-check-input attendance-checkbox" type="checkbox"
                         id="present_{{ s.id }}" name="present_{{ s.id }}"
                         {% if attendance.get(s.id, False) %}checked{% endif %}>
                  <label class="form-check-label" for="present_{{ s.id }}"></label>
                </div>
              </td>
              <td>
                <span class="badge {% if attendance.get(s.id, False) %}bg-success{% else %}bg-danger{% endif %}">
                  {% if attendance.get(s.id, False) %}Present{% else %}Absent{% endif %}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <button type="button" class="btn btn-outline-secondary" onclick="markAllPresent()">
            <i class="fas fa-check-double me-2"></i>Mark All Present
          </button>
          <button type="button" class="btn btn-outline-warning" onclick="markAllAbsent()">
            <i class="fas fa-times me-2"></i>Mark All Absent
          </button>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-2"></i>Save Attendance
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function markAllPresent() {
  document.querySelectorAll('.attendance-checkbox').forEach(cb => cb.checked = true);
  updateStatusBadges();
}

function markAllAbsent() {
  document.querySelectorAll('.attendance-checkbox').forEach(cb => cb.checked = false);
  updateStatusBadges();
}

function updateStatusBadges() {
  document.querySelectorAll('.attendance-checkbox').forEach(cb => {
    const row = cb.closest('tr');
    const badge = row.querySelector('.badge');
    if (cb.checked) {
      badge.className = 'badge bg-success';
      badge.textContent = 'Present';
    } else {
      badge.className = 'badge bg-danger';
      badge.textContent = 'Absent';
    }
  });
}

// Update status badges when checkboxes change
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.attendance-checkbox').forEach(cb => {
    cb.addEventListener('change', updateStatusBadges);
  });
});

function exportAttendance() {
  alert('Exporting attendance data...\nData will be downloaded as CSV file shortly.');
}

function sendAbsentNotifications() {
  if (confirm('Are you sure you want to send notifications to absent students?')) {
    fetch('/api/send_absent_notifications', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        date: document.getElementById('attendance_date').value
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Notifications sent successfully.\nDelivered: ' + (data.sent_count || 0) + '\nEmail: ' + (data.email_sent || 0) + '\nSMS: ' + (data.sms_sent || 0));
      } else {
        alert('Failed to send notifications: ' + (data.message || 'Unknown error'));
      }
    })
    .catch(error => {
      alert('Error sending notifications: ' + error.message);
    });
  }
}
</script>

{% endblock %}
